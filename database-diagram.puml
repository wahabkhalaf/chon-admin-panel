-- USERS (Admin and Moderator accounts)
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('admin', 'moderator') NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PLAYERS (Game players - no wallet balance)
CREATE TABLE players (
    id SERIAL PRIMARY KEY,
    whatsapp_number VARCHAR(20) UNIQUE NOT NULL,
    nickname VARCHAR(255) NOT NULL,
    total_score INTEGER DEFAULT 0,
    level INTEGER DEFAULT 1,
    experience_points INTEGER DEFAULT 0,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PLAYER OTPS (for registration/login)
CREATE TABLE player_otps (
    id SERIAL PRIMARY KEY,
    player_id INT NOT NULL REFERENCES players(id) ON DELETE CASCADE,
    otp_code VARCHAR(10) NOT NULL,
    purpose ENUM('login', 'register', 'password_reset') NOT NULL,
    is_verified BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ACHIEVEMENTS
CREATE TABLE achievements (
    id SERIAL PRIMARY KEY,
    player_id INT NOT NULL REFERENCES players(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    unlocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- COMPETITIONS
CREATE TABLE competitions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    entry_fee DECIMAL(10, 2) NOT NULL,
    prize_pool DECIMAL(10, 2) DEFAULT 0,
    open_time TIMESTAMP NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    max_users INT NOT NULL,
    game_type VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- The prize_tiers table defines how the total prize pool of a competition is distributed based on player ranking.
-- Each tier covers a range of ranks (e.g., 1st place, 2nd–3rd place, 4th–10th place).
-- Each tier defines:
-- What type of prize (cash, item, points).
-- How much prize value to give.
    
-- PRIZE TIERS
CREATE TABLE prize_tiers (
    id SERIAL PRIMARY KEY,
    competition_id INT NOT NULL REFERENCES competitions(id) ON DELETE CASCADE,
    rank_from INT NOT NULL,
    rank_to INT NOT NULL,
    prize_type ENUM('cash', 'item', 'points') NOT NULL,
    prize_value DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- QUESTIONS
CREATE TABLE questions (
    id SERIAL PRIMARY KEY,
    question_text TEXT NOT NULL,
    question_type ENUM('multiple_choice', 'puzzle', 'pattern', 'true_false', 'math') NOT NULL,
    options JSONB,
    correct_answer TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- COMPETITIONS QUESTIONS (pivot)
CREATE TABLE competitions_questions (
    id SERIAL PRIMARY KEY,
    competition_id INT NOT NULL REFERENCES competitions(id) ON DELETE CASCADE,
    question_id INT NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- USER ANSWERS
CREATE TABLE user_answers (
    id SERIAL PRIMARY KEY,
    player_id INT NOT NULL REFERENCES players(id) ON DELETE CASCADE,
    competition_id INT NOT NULL REFERENCES competitions(id) ON DELETE CASCADE,
    question_id INT NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
    user_answer TEXT NOT NULL,
    is_correct BOOLEAN NOT NULL,
    answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- SESSION LEADERBOARD
CREATE TABLE session_leaderboard (
    id SERIAL PRIMARY KEY,
    player_id INT NOT NULL REFERENCES players(id) ON DELETE CASCADE,
    competition_id INT NOT NULL REFERENCES competitions(id) ON DELETE CASCADE,
    score INT NOT NULL,
    rank INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- TRANSACTIONS (only when applying to competitions)
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    player_id INT NOT NULL REFERENCES players(id) ON DELETE CASCADE,
    competition_id INT NOT NULL REFERENCES competitions(id) ON DELETE CASCADE,
    amount DECIMAL(10, 2) NOT NULL,
    transaction_type ENUM('entry_fee') NOT NULL,
    status ENUM('pending', 'completed', 'failed') NOT NULL,
    payment_method VARCHAR(255),
    payment_provider VARCHAR(255),
    payment_details JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PAYMENT METHODS (available for players)
CREATE TABLE payment_methods (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    code VARCHAR(50) NOT NULL,
    provider VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    supports_deposit BOOLEAN DEFAULT TRUE,
    supports_withdrawal BOOLEAN DEFAULT TRUE,
    min_amount DECIMAL(10, 2) DEFAULT 0,
    max_amount DECIMAL(10, 2) DEFAULT 10000,
    fee_fixed DECIMAL(10, 2) DEFAULT 0,
    fee_percentage DECIMAL(5, 2) DEFAULT 0,
    processing_time_hours INT DEFAULT 24,
    instructions TEXT,
    config JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PLAYER PAYMENT METHODS (saved external payment info)
CREATE TABLE player_payment_methods (
    id SERIAL PRIMARY KEY,
    player_id INT NOT NULL REFERENCES players(id) ON DELETE CASCADE,
    payment_method_id INT NOT NULL REFERENCES payment_methods(id) ON DELETE CASCADE,
    token TEXT,
    external_id TEXT,
    nickname VARCHAR(255),
    details JSONB,
    is_default BOOLEAN DEFAULT FALSE,
    last_used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);